<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alkali & Alkaline Earth Metals Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: #000000;
            color: #e2e8f0;
            position: relative;
            overflow-x: hidden;
        }
        /* --- Global Styling --- */
        .neon-glow {
            text-shadow: none;
        }
        .neon-border {
            border: 2px solid #4ade80;
            box-shadow: 0 0 5px #4ade80;
        }
        .flashy-button {
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-weight: bold;
        }
        .flashy-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 5px 20px rgba(74, 222, 128, 0.6);
        }
        
        /* --- New Font for Data Log --- */
        /* Removed console-font class to use Inter as requested */
        /* --- Animations --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.8s ease-in-out; }
        @keyframes appear {
            0% { opacity: 0; transform: scale(0.5); }
            100% { opacity: 1; transform: scale(1); }
        }
        .appear-anim { animation: appear 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        /* --- Message Box --- */
        .message-box {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
        }
        /* Custom canvas styling for 2D */
        #atom-canvas {
            background-color: #1f2937;
            display: block;
        }
        .color-circle {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        .quiz-option {
            transition: all 0.2s ease;
            text-align: left;
        }
        .quiz-option:hover:not(.selected) {
            background-color: #4a5568;
        }
        .quiz-option.selected {
            border-color: #4ade80;
            background-color: #4ade80;
            color: #000;
        }
        .quiz-option.correct {
            border-color: #4ade80;
            background-color: #16a34a; /* Green */
        }
        .quiz-option.incorrect {
            border-color: #ef4444;
            background-color: #dc2626; /* Red */
        }
        .quiz-option.correct-unselected {
            border-color: #4ade80;
            background-color: #16a34a;
            opacity: 0.6;
        }
        /* Hotspot specific styles */
        .hotspot-container {
            position: relative;
            user-select: none;
            display: inline-block;
            border: 2px solid #4a5568;
            border-radius: 8px;
            overflow: hidden;
            max-width: 600px;
        }
        .hotspot-wrapper {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .hotspot-label {
            margin-left: 8px;
            font-weight: bold;
            color: #e2e8f0;
        }
        .hotspot-btn {
            width: 24px;
            height: 24px;
            background-color: #4a5568;
            border-radius: 4px;
            border: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        .hotspot-btn:hover {
            border-color: #4ade80;
        }
        .hotspot-btn.selected {
            background-color: #4ade80;
            border-color: #4ade80;
        }
        .hotspot-btn.correct {
            background-color: #16a34a;
            border-color: #16a34a;
        }
        .hotspot-btn.incorrect {
            background-color: #dc2626;
            border-color: #dc2626;
        }
        /* Drag-and-drop specific styles */
        .draggable-item {
            cursor: grab;
            transition: transform 0.2s;
            flex-grow: 1;
        }
        .dragging {
            opacity: 0.5;
            border: 2px dashed #4ade80;
        }
        .dropzone {
            min-width: 120px;
            min-height: 48px;
            background-color: #2d3748;
            border: 2px dashed #4a5568;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 8px;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .dropzone.drag-over {
            background-color: #4a5568;
            border-color: #4ade80;
        }
        /* Hide default input range focus outline */
        input[type=range]:focus {
            outline: none;
        }
        /* Custom slider styles for webkit browsers */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #4ade80;
            cursor: pointer;
            box-shadow: 0 0 5px #4ade80;
            margin-top: -8px; /* Offset the thumb to center it vertically */
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            background: #2d3748;
            border-radius: 4px;
        }
        /* Custom slider styles for Firefox */
        input[type=range]::-moz-range-thumb {
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #4ade80;
            cursor: pointer;
            box-shadow: 0 0 5px #4ade80;
        }
        input[type=range]::-moz-range-track {
            width: 100%;
            height: 8px;
            background: #2d3748;
            border-radius: 4px;
        }
        .learn-tab {
            transition: all 0.2s ease;
            cursor: pointer;
            font-weight: bold;
        }
        .learn-tab:hover {
            color: #4ade80;
        }
        .learn-tab.active {
            color: #4ade80;
            border-bottom: 2px solid #4ade80;
        }
        .fill-in-blank-input {
            width: 80px;
            text-align: center;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 4px;
            padding: 4px;
            color: white;
        }
        .fill-in-blank-input:focus {
            outline: none;
            border-color: #4ade80;
        }
        .correct-answer-text {
            color: #4ade80;
        }
        .incorrect-answer-text {
            color: #dc2626;
        }
        .match-item {
            padding: 8px;
            background-color: #2d3748;
            border: 2px solid #4a5568;
            border-radius: 8px;
            cursor: grab;
            margin-bottom: 4px;
        }
        .dropzone-match {
            min-height: 40px;
            border: 2px dashed #4a5568;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            transition: background-color 0.2s;
        }
        .dropzone-match.drag-over {
            background-color: #4a5568;
        }
    </style>
</head>
<body class="p-6">
    <!-- Main Container -->
    <div id="app-container" class="min-h-screen flex flex-col items-center justify-center p-4 lg:p-8">
        <!-- Header -->
        <header class="w-full max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-center p-4 mb-8 bg-zinc-900 rounded-xl border border-gray-800 shadow-2xl neon-border">
            <nav class="flex flex-wrap gap-4 mt-4 md:mt-0">
                <button id="nav-hub-btn" class="flashy-button px-4 py-2 bg-zinc-700 hover:bg-zinc-600 rounded-lg text-white font-semibold shadow-md border-2 border-zinc-500">Hub</button>
                <button id="nav-learn-btn" class="flashy-button px-4 py-2 bg-emerald-700 hover:bg-emerald-600 rounded-lg text-white font-semibold shadow-md border-2 border-emerald-500">Learn</button>
                <button id="nav-prequiz-btn" class="flashy-button px-4 py-2 bg-purple-700 hover:bg-purple-600 rounded-lg text-white font-semibold shadow-md border-2 border-purple-500">Pre-Quiz</button>
                <button id="nav-postquiz-btn" class="flashy-button px-4 py-2 bg-rose-700 hover:bg-rose-600 rounded-lg text-white font-semibold shadow-md border-2 border-rose-500">Post-Quiz</button>
                <button id="nav-leaderboard-btn" class="flashy-button px-4 py-2 bg-yellow-700 hover:bg-yellow-600 rounded-lg text-white font-semibold shadow-md border-2 border-yellow-500">Leaderboard</button>
            </nav>
        </header>
        <!-- Main Content Area -->
        <main id="main-content" class="w-full max-w-7xl flex-grow fade-in">
            <!-- Loading/Message box (hidden by default) -->
            <div id="message-box" class="message-box fixed hidden p-6 bg-zinc-900 rounded-xl shadow-lg border-2 border-rose-500 text-center fade-in">
                <p id="message-text" class="text-xl text-white font-bold mb-4">Feature coming soon!</p>
                <button id="close-message-btn" class="flashy-button px-4 py-2 bg-rose-700 hover:bg-rose-600 rounded-lg text-white">Close</button>
            </div>
            
            <!-- Learning Content Section (hidden by default) -->
            <div id="learn-panel" class="hidden bg-zinc-900 p-8 rounded-xl shadow-lg border border-gray-800 relative">
                <button id="back-to-hub-btn" class="absolute top-4 right-4 flashy-button px-4 py-2 bg-zinc-700 hover:bg-zinc-600 rounded-lg text-white font-semibold shadow-md border-2 border-zinc-500">Back to Hub</button>
                <h2 class="text-3xl font-bold text-emerald-400 mb-6 text-center neon-glow">Learn about Alkali & Alkaline Earth Metals</h2>
                <!-- Tab Navigation for Learn Section -->
                <div role="tablist" aria-label="Chemical Groups" class="flex justify-center space-x-4 mb-6 border-b border-gray-700">
                    <button role="tab" id="group-1-tab" aria-controls="group-1-content" aria-selected="true" class="learn-tab px-4 py-2 text-white active">Group 1: Alkali Metals</button>
                    <button role="tab" id="group-2-tab" aria-controls="group-2-content" aria-selected="false" class="learn-tab px-4 py-2 text-white">Group 2: Alkaline Earth Metals</button>
                </div>
                <!-- Tab Content Container -->
                <div id="learn-content-container" class="prose prose-invert max-w-none text-white overflow-y-auto max-h-[70vh]">
                    <div id="group-1-content" role="tabpanel" aria-labelledby="group-1-tab" class="fade-in">
                        <!-- Content for Group 1 will be injected here -->
                    </div>
                    <div id="group-2-content" role="tabpanel" aria-labelledby="group-2-tab" class="fade-in hidden">
                        <!-- Content for Group 2 will be injected here -->
                    </div>
                </div>
                <div id="safety-notes-content" class="prose prose-invert max-w-none text-white overflow-y-auto mt-8">
                    <!-- Safety notes will be injected here -->
                </div>
            </div>
            
            <!-- Pre-Quiz Section (hidden by default) -->
            <div id="prequiz-panel" class="hidden bg-zinc-900 p-8 rounded-xl shadow-lg border border-gray-800 relative">
                <button id="back-to-hub-btn-quiz" class="absolute top-4 right-4 flashy-button px-4 py-2 bg-zinc-700 hover:bg-zinc-600 rounded-lg text-white font-semibold shadow-md border-2 border-zinc-500">Back to Hub</button>
                <h2 class="text-3xl font-bold text-purple-400 mb-6 text-center neon-glow">PRE-QUIZ (7 Questions)</h2>
                <div id="prequiz-content" class="prose prose-invert max-w-none text-white overflow-y-auto max-h-[70vh]">
                    <!-- Quiz questions will be dynamically injected here -->
                </div>
                <div class="mt-6 flex flex-col items-center">
                    <button id="prequiz-submit-btn" class="flashy-button px-6 py-3 bg-purple-700 hover:bg-purple-600 rounded-lg text-white font-semibold shadow-md border-2 border-purple-500">Submit Answers</button>
                    <div id="prequiz-results" class="mt-4 text-center text-xl font-bold"></div>
                </div>
            </div>
            <!-- Post-Quiz Section (hidden by default) -->
            <div id="postquiz-panel" class="hidden bg-zinc-900 p-8 rounded-xl shadow-lg border border-gray-800 relative">
                <button id="back-to-hub-btn-postquiz" class="absolute top-4 right-4 flashy-button px-4 py-2 bg-zinc-700 hover:bg-zinc-600 rounded-lg text-white font-semibold shadow-md border-2 border-zinc-500">Back to Hub</button>
                <h2 class="text-3xl font-bold text-rose-400 mb-6 text-center neon-glow">Post-Quiz: Final Assessment</h2>
                <div id="postquiz-content" class="prose prose-invert max-w-none text-white overflow-y-auto max-h-[70vh]">
                    <!-- Post-Quiz questions will be dynamically injected here -->
                </div>
                <div class="mt-6 flex flex-col items-center">
                    <button id="postquiz-submit-btn" class="flashy-button px-6 py-3 bg-rose-700 hover:bg-rose-600 rounded-lg text-white font-semibold shadow-md border-2 border-rose-500">Submit Answers</button>
                    <div id="postquiz-results" class="mt-4 text-center text-xl font-bold"></div>
                </div>
            </div>
            <!-- Hub Grid Section (visible by default) -->
            <div id="hub-grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Left Panel: Elements -->
                <div id="element-panel" class="bg-zinc-900 p-6 rounded-xl shadow-lg flex flex-col justify-start border border-gray-800">
                    <h2 class="text-2xl font-bold text-sky-400 mb-4 neon-glow">Elements Database</h2>
                    <div id="group-i-elements" class="mb-6">
                        <h3 class="text-xl font-semibold mb-2 text-sky-300">Group I (Alkali Metals)</h3>
                        <div class="grid grid-cols-2 lg:grid-cols-2 gap-4">
                            <!-- Element buttons will be dynamically generated -->
                        </div>
                    </div>
                    <div id="group-ii-elements">
                        <h3 class="text-xl font-semibold mb-2 text-emerald-300">Group II (Alkaline Earth Metals)</h3>
                        <div class="grid grid-cols-2 lg:grid-cols-2 gap-4">
                            <!-- Element buttons will be dynamically generated -->
                        </div>
                    </div>
                </div>
                <!-- Center Panel: 2D Atom Viewer -->
                <div id="atom-viewer-container" class="relative bg-zinc-900 rounded-xl shadow-lg flex-grow overflow-hidden p-6 border border-gray-800 neon-border flex flex-col">
                    <h2 class="text-2xl font-bold text-center text-white mb-4 neon-glow">Interactive Atom Viewer</h2>
                    <div class="relative w-full h-80 lg:h-full flex items-center justify-center bg-zinc-800 rounded-lg overflow-hidden border border-gray-700 flex-grow">
                        <canvas id="atom-canvas"></canvas>
                    </div>
                    <div id="atom-key" class="p-4 mt-4 bg-zinc-800 rounded-lg border border-gray-700 text-sm text-center flex flex-wrap justify-center gap-4">
                        <div class="flex items-center">
                            <span class="color-circle" style="background-color: #ef4444;"></span> Nucleus (Protons & Neutrons)
                        </div>
                        <div class="flex items-center">
                            <span class="color-circle" style="background-color: #4ade80;"></span> Inner-shell Electrons
                        </div>
                        <div class="flex items-center">
                            <span class="color-circle" style="background-color: #fcd34d;"></span> Valence Electrons
                        </div>
                    </div>
                </div>
                <!-- Right Panel: Facts & Features -->
                <div id="features-panel" class="bg-zinc-900 p-6 rounded-xl shadow-lg flex flex-col justify-between border border-gray-800">
                    <div id="facts-container" class="flex flex-col h-full">
                        <h2 class="text-2xl font-bold mb-4 text-purple-300">Element Data</h2>
                        <div id="facts-content" class="bg-zinc-800 p-4 rounded-lg flex-grow border border-gray-700 font-sans text-slate-200 overflow-y-auto">
                            <!-- Detailed facts will be injected here with typing animation -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- User ID display for Firestore -->
        <div class="w-full max-w-7xl mx-auto p-2 mt-4 text-center text-sm text-zinc-400">
            User ID: <span id="user-id-display">Connecting...</span>
        </div>
    </div>
    <!-- Firebase SDKs and all application logic in a single module script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Firebase Global Variables (Provided by Canvas Environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let db, auth, userId;
        let isAuthReady = false;
        let typingAnimationRunning = false;
        let animationTimeout;
        // --- Data for all elements and quizzes ---
        const elementsData = {
            "Lithium": { group: 'I', atomicNumber: 3, protons: 3, neutrons: 4, electrons: 3, symbol: 'Li', funFact: "Used in batteries for phones and electric cars.", electronConfiguration: "1s² 2s¹", ionizationEnergy: "520.2 kJ/mol", electronegativity: "0.98", meltingPoint: "180.5°C", boilingPoint: "1342°C" },
            "Sodium": { group: 'I', atomicNumber: 11, protons: 11, neutrons: 12, electrons: 11, symbol: 'Na', funFact: "A key component of table salt (NaCl).", electronConfiguration: "[Ne] 3s¹", ionizationEnergy: "495.8 kJ/mol", electronegativity: "0.93", meltingPoint: "97.8°C", boilingPoint: "883°C" },
            "Potassium": { group: 'I', atomicNumber: 19, protons: 19, neutrons: 20, electrons: 19, symbol: 'K', funFact: "Essential for nervous system and muscle function.", electronConfiguration: "[Ar] 4s¹", ionizationEnergy: "418.8 kJ/mol", electronegativity: "0.82", meltingPoint: "63.5°C", boilingPoint: "759°C" },
            "Rubidium": { group: 'I', atomicNumber: 37, protons: 37, neutrons: 48, electrons: 37, symbol: 'Rb', funFact: "So reactive it can ignite spontaneously in air!", electronConfiguration: "[Kr] 5s¹", ionizationEnergy: "403.0 kJ/mol", electronegativity: "0.82", meltingPoint: "39.3°C", boilingPoint: "688°C" },
            "Cesium": { group: 'I', atomicNumber: 55, protons: 55, neutrons: 78, electrons: 55, symbol: 'Cs', funFact: "Used in atomic clocks and is the most reactive of the alkali metals.", electronConfiguration: "[Xe] 6s¹", ionizationEnergy: "375.7 kJ/mol", electronegativity: "0.79", meltingPoint: "28.5°C", boilingPoint: "671°C" },
            "Francium": { group: 'I', atomicNumber: 87, protons: 87, neutrons: 136, electrons: 87, symbol: 'Fr', funFact: "Extremely rare and radioactive, with a half-life of only 22 minutes.", electronConfiguration: "[Rn] 7s¹", ionizationEnergy: "392.8 kJ/mol", electronegativity: "0.7", meltingPoint: "27°C", boilingPoint: "677°C" },
            "Beryllium": { group: 'II', atomicNumber: 4, protons: 4, neutrons: 5, electrons: 4, symbol: 'Be', funFact: "Used to make strong, lightweight alloys for aircraft.", electronConfiguration: "1s² 2s²", ionizationEnergy: "899.5 kJ/mol", electronegativity: "1.57", meltingPoint: "1287°C", boilingPoint: "2471°C" },
            "Magnesium": { group: 'II', atomicNumber: 12, protons: 12, neutrons: 12, electrons: 12, symbol: 'Mg', funFact: "A key element in chlorophyll, which makes plants green.", electronConfiguration: "[Ne] 3s²", ionizationEnergy: "737.7 kJ/mol", electronegativity: "1.31", meltingPoint: "650°C", boilingPoint: "1091°C" },
            "Calcium": { group: 'II', atomicNumber: 20, protons: 20, neutrons: 20, electrons: 20, symbol: 'Ca', funFact: "The primary component of bones and teeth.", electronConfiguration: "[Ar] 4s²", ionizationEnergy: "589.8 kJ/mol", electronegativity: "1.0", meltingPoint: "842°C", boilingPoint: "1484°C" },
            "Strontium": { group: 'II', atomicNumber: 38, protons: 38, neutrons: 50, electrons: 38, symbol: 'Sr', funFact: "Compounds are used to create the vibrant red color in fireworks.", electronConfiguration: "[Kr] 5s²", ionizationEnergy: "549.5 kJ/mol", electronegativity: "0.95", meltingPoint: "777°C", boilingPoint: "1382°C" },
            "Barium": { group: 'II', atomicNumber: 56, protons: 56, neutrons: 81, electrons: 56, symbol: 'Ba', funFact: "Used in medical imaging to help doctors see the digestive system.", electronConfiguration: "[Xe] 6s²", ionizationEnergy: "502.9 kJ/mol", electronegativity: "0.89", meltingPoint: "727°C", boilingPoint: "1897°C" },
            "Radium": { group: 'II', atomicNumber: 88, protons: 88, neutrons: 138, electrons: 88, symbol: 'Ra', funFact: "Highly radioactive and was once used in luminescent paints for watch dials.", electronConfiguration: "[Rn] 7s²", ionizationEnergy: "509.3 kJ/mol", electronegativity: "0.9", meltingPoint: "700°C", boilingPoint: "1737°C" }
        };
        const learnContent = {
            group1: `
                <h3 class="text-2xl font-semibold mt-6 mb-4 text-emerald-300">Group 1: Alkali Metals (Li, Na, K, Rb, Cs, Fr)</h3>
                
                <h4 class="text-xl font-semibold mt-6 mb-3 text-emerald-300">1. General Properties</h4>
                <ul class="list-disc pl-6 space-y-2">
                    <li><strong>Shiny and soft:</strong> Fresh metals have a metallic luster but are soft and can be cut with a knife.</li>
                    <li><strong>Low density:</strong> Li, Na, and K are less dense than water (they float!).</li>
                    <li><strong>Low melting and boiling points:</strong> Decrease down the group (Li highest, Cs lowest).</li>
                    <li><strong>Form basic oxides and hydroxides:</strong> React with water to produce alkaline solutions.</li>
                    <li><strong>Highly reactive:</strong> Reactivity increases down the group (Li < Na < K < Rb < Cs).</li>
                </ul>
                
                <h4 class="text-xl font-semibold mt-6 mb-3 text-emerald-300">2. Physical Properties</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-zinc-800 rounded-lg overflow-hidden">
                        <thead>
                            <tr class="bg-zinc-700">
                                <th class="py-2 px-4 text-left">Property</th>
                                <th class="py-2 px-4 text-left">Trend Down the Group</th>
                                <th class="py-2 px-4 text-left">Example</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b border-zinc-700">
                                <td class="py-2 px-4">Density</td>
                                <td class="py-2 px-4">Increases (except K < Na)</td>
                                <td class="py-2 px-4">Li: 0.53 g/cm³, Na: 0.97 g/cm³, K: 0.86 g/cm³</td>
                            </tr>
                            <tr class="border-b border-zinc-700">
                                <td class="py-2 px-4">Melting/Boiling point</td>
                                <td class="py-2 px-4">Decreases</td>
                                <td class="py-2 px-4">Li: 180°C, Na: 98°C, K: 63°C</td>
                            </tr>
                            <tr class="border-b border-zinc-700">
                                <td class="py-2 px-4">Hardness</td>
                                <td class="py-2 px-4">Decreases</td>
                                <td class="py-2 px-4">Li: hard, Cs: very soft</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-4">Appearance</td>
                                <td class="py-2 px-4">Shiny when freshly cut, dulls quickly</td>
                                <td class="py-2 px-4">Na tarnishes faster than Li</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h4 class="text-xl font-semibold mt-6 mb-3 text-emerald-300">3. Chemical Properties</h4>
                
                <h5 class="text-lg font-semibold mt-4 mb-2 text-emerald-200">a) Reaction with Water</h5>
                <p class="mb-3">Produces hydrogen gas and an alkaline solution of metal hydroxide.</p>
                <p class="mb-3"><strong>Equation example:</strong></p>
                <p class="mb-3 bg-zinc-800 p-3 rounded-lg">2Na + 2H₂O → 2NaOH + H₂↑</p>
                <p class="mb-3"><strong>Observation:</strong></p>
                <ul class="list-disc pl-6 space-y-1 mb-3">
                    <li>Effervescence (bubbles of H₂)</li>
                    <li>Metal moves on water surface</li>
                    <li>Heat released (sometimes ignites H₂, especially K, Rb, Cs)</li>
                </ul>
                
                <h5 class="text-lg font-semibold mt-4 mb-2 text-emerald-200">b) Reaction with Oxygen</h5>
                <p class="mb-3">Forms metal oxides:</p>
                <div class="bg-zinc-800 p-3 rounded-lg mb-3">
                    <p>4Li + O₂ → 2Li₂O (lithium oxide)</p>
                    <p>2Na + O₂ → Na₂O₂ (sodium peroxide)</p>
                    <p>K + O₂ → KO₂ (potassium superoxide)</p>
                </div>
                
                <h5 class="text-lg font-semibold mt-4 mb-2 text-emerald-200">c) Reaction with Halogens</h5>
                <p class="mb-3">Forms ionic halides (white solids, soluble in water):</p>
                <div class="bg-zinc-800 p-3 rounded-lg mb-3">
                    <p>2Na + Cl₂ → 2NaCl</p>
                </div>
                
                <h5 class="text-lg font-semibold mt-4 mb-2 text-emerald-200">d) Reaction with Acids</h5>
                <p class="mb-3">React vigorously with dilute acids, releasing H₂:</p>
                <div class="bg-zinc-800 p-3 rounded-lg mb-3">
                    <p>2K + 2HCl → 2KCl + H₂↑</p>
                </div>
                
                <h4 class="text-xl font-semibold mt-6 mb-3 text-emerald-300">4. Trends Down the Group</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-zinc-800 rounded-lg overflow-hidden">
                        <thead>
                            <tr class="bg-zinc-700">
                                <th class="py-2 px-4 text-left">Property</th>
                                <th class="py-2 px-4 text-left">Trend</th>
                                <th class="py-2 px-4 text-left">Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b border-zinc-700">
                                <td class="py-2 px-4">Reactivity</td>
                                <td class="py-2 px-4">Increases</td>
                                <td class="py-2 px-4">Outer electron is further from nucleus → easier to lose</td>
                            </tr>
                            <tr class="border-b border-zinc-700">
                                <td class="py-2 px-4">Melting/Boiling point</td>
                                <td class="py-2 px-4">Decreases</td>
                                <td class="py-2 px-4">Weaker metallic bonds down the group</td>
                            </tr>
                            <tr class="border-b border-zinc-700">
                                <td class="py-2 px-4">Density</td>
                                <td class="py-2 px-4">Generally increases</td>
                                <td class="py-2 px-4">Atomic mass increases</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-4">Oxides formed</td>
                                <td class="py-2 px-4">Li → Li₂O, Na → Na₂O₂, K → KO₂</td>
                                <td class="py-2 px-4">More complex oxides as atom gets bigger</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h4 class="text-xl font-semibold mt-6 mb-3 text-emerald-300">5. Safety Notes</h4>
                <ul class="list-disc pl-6 space-y-2">
                    <li>Alkali metals are very reactive, especially with water.</li>
                    <li>Store under oil to prevent reaction with air/moisture.</li>
                    <li>Handle with tongs and protective equipment in labs.</li>
                </ul>
                
                <h4 class="text-xl font-semibold mt-6 mb-3 text-emerald-300">6. Key Observations in Experiments</h4>
                <ul class="list-disc pl-6 space-y-2">
                    <li><strong>Li + Water:</strong> Fizzes slowly, floats, may move.</li>
                    <li><strong>Na + Water:</strong> Fizzes faster, floats, may melt into a ball.</li>
                    <li><strong>K + Water:</strong> Fizzes vigorously, floats, may ignite hydrogen gas.</li>
                </ul>
            `,
            group2: `
                <h3 class="text-2xl font-semibold mt-6 mb-4 text-emerald-300">Group 2: Alkaline Earth Metals (Be, Mg, Ca, Sr, Ba, Ra)</h3>
                
                <h4 class="text-xl font-semibold mt-6 mb-3 text-emerald-300">1. General Properties</h4>
                <ul class="list-disc pl-6 space-y-2">
                    <li><strong>Shiny and metallic:</strong> Fresh metals have a metallic luster; slightly harder than Group 1 metals.</li>
                    <li><strong>Reactive, but less than Group 1:</strong> Reactivity increases down the group.</li>
                    <li><strong>Form basic oxides and hydroxides:</strong> Produce alkaline solutions in water.</li>
                    <li><strong>Divalent metals:</strong> Form ions with a +2 charge (e.g., Ca²⁺, Mg²⁺).</li>
                </ul>
                
                <h4 class="text-xl font-semibold mt-6 mb-3 text-emerald-300">2. Physical Properties</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-zinc-800 rounded-lg overflow-hidden">
                        <thead>
                            <tr class="bg-zinc-700">
                                <th class="py-2 px-4 text-left">Property</th>
                                <th class="py-2 px-4 text-left">Trend Down the Group</th>
                                <th class="py-2 px-4 text-left">Example</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b border-zinc-700">
                                <td class="py-2 px-4">Density</td>
                                <td class="py-2 px-4">Increases</td>
                                <td class="py-2 px-4">Be: 1.85 g/cm³, Mg: 1.74 g/cm³, Ca: 1.55 g/cm³</td>
                            </tr>
                            <tr class="border-b border-zinc-700">
                                <td class="py-2 px-4">Melting/Boiling point</td>
                                <td class="py-2 px-4">Decreases</td>
                                <td class="py-2 px-4">Be: 1287°C, Mg: 650°C, Ba: 725°C</td>
                            </tr>
                            <tr class="border-b border-zinc-700">
                                <td class="py-2 px-4">Hardness</td>
                                <td class="py-2 px-4">Decreases</td>
                                <td class="py-2 px-4">Be: hard, Ba: soft</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-4">Appearance</td>
                                <td class="py-2 px-4">Shiny when freshly cut, dulls quickly</td>
                                <td class="py-2 px-4">Similar to Group 1 but slightly harder</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h4 class="text-xl font-semibold mt-6 mb-3 text-emerald-300">3. Chemical Properties</h4>
                
                <h5 class="text-lg font-semibold mt-4 mb-2 text-emerald-200">a) Reaction with Water</h5>
                <p class="mb-3">Be and Mg: Do not react with cold water; react slowly with steam.</p>
                <p class="mb-3">Ca, Sr, Ba: React with cold water to form hydroxides and hydrogen gas.</p>
                <p class="mb-3"><strong>Equation examples:</strong></p>
                <div class="bg-zinc-800 p-3 rounded-lg mb-3">
                    <p>Ca + 2H₂O → Ca(OH)₂ + H₂↑</p>
                    <p>Mg + H₂O(steam) → MgO + H₂↑</p>
                </div>
                <p class="mb-3"><strong>Observation:</strong></p>
                <ul class="list-disc pl-6 space-y-1 mb-3">
                    <li>Effervescence (bubbles of H₂)</li>
                    <li>Metal dissolves slowly or floats on water</li>
                </ul>
                
                <h5 class="text-lg font-semibold mt-4 mb-2 text-emerald-200">b) Reaction with Oxygen</h5>
                <p class="mb-3">Forms oxides:</p>
                <div class="bg-zinc-800 p-3 rounded-lg mb-3">
                    <p>2Mg + O₂ → 2MgO</p>
                    <p>Ca + O₂ → 2CaO</p>
                </div>
                
                <h5 class="text-lg font-semibold mt-4 mb-2 text-emerald-200">c) Reaction with Halogens</h5>
                <p class="mb-3">Forms ionic halides (white solids, soluble in water):</p>
                <div class="bg-zinc-800 p-3 rounded-lg mb-3">
                    <p>Mg + Cl₂ → MgCl₂</p>
                </div>
                
                <h5 class="text-lg font-semibold mt-4 mb-2 text-emerald-200">d) Reaction with Acids</h5>
                <p class="mb-3">Reacts with dilute acids to release hydrogen gas:</p>
                <div class="bg-zinc-800 p-3 rounded-lg mb-3">
                    <p>Mg + 2HCl → MgCl₂ + H₂↑</p>
                </div>
                
                <h4 class="text-xl font-semibold mt-6 mb-3 text-emerald-300">4. Trends Down the Group</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-zinc-800 rounded-lg overflow-hidden">
                        <thead>
                            <tr class="bg-zinc-700">
                                <th class="py-2 px-4 text-left">Property</th>
                                <th class="py-2 px-4 text-left">Trend</th>
                                <th class="py-2 px-4 text-left">Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b border-zinc-700">
                                <td class="py-2 px-4">Reactivity</td>
                                <td class="py-2 px-4">Increases</td>
                                <td class="py-2 px-4">Outer electrons are further from nucleus → easier to lose</td>
                            </tr>
                            <tr class="border-b border-zinc-700">
                                <td class="py-2 px-4">Melting/Boiling point</td>
                                <td class="py-2 px-4">Decreases</td>
                                <td class="py-2 px-4">Metallic bonding becomes weaker down the group</td>
                            </tr>
                            <tr class="border-b border-zinc-700">
                                <td class="py-2 px-4">Density</td>
                                <td class="py-2 px-4">Increases</td>
                                <td class="py-2 px-4">Atomic mass increases</td>
                            </tr>
                            <tr class="border-b border-zinc-700">
                                <td class="py-2 px-4">Solubility of hydroxides</td>
                                <td class="py-2 px-4">Increases</td>
                                <td class="py-2 px-4">Mg(OH)₂ least soluble, Ba(OH)₂ most soluble</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-4">Solubility of sulfates</td>
                                <td class="py-2 px-4">Decreases</td>
                                <td class="py-2 px-4">MgSO₄ soluble, BaSO₄ insoluble</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h4 class="text-xl font-semibold mt-6 mb-3 text-emerald-300">5. Uses of Group 2 Metals</h4>
                <ul class="list-disc pl-6 space-y-2">
                    <li><strong>Mg:</strong> Aircraft parts, fireworks (bright white flame)</li>
                    <li><strong>Ca:</strong> Cement, building materials, neutralizing soil acidity</li>
                    <li><strong>Ba:</strong> Barium meals (X-ray imaging)</li>
                    <li><strong>MgO / CaO:</strong> Refractory materials, neutralizing acids</li>
                </ul>
                
                <h4 class="text-xl font-semibold mt-6 mb-3 text-emerald-300">6. Safety Notes</h4>
                <ul class="list-disc pl-6 space-y-2">
                    <li>Store metals away from moisture to prevent unwanted reactions.</li>
                    <li>Ba compounds (except BaSO₄) are toxic – handle with care.</li>
                    <li>Use protective equipment during experiments.</li>
                </ul>
                
                <h4 class="text-xl font-semibold mt-6 mb-3 text-emerald-300">7. Key Observations in Experiments</h4>
                <ul class="list-disc pl-6 space-y-2">
                    <li><strong>Mg + Water:</strong> Very slow, only reacts with steam. Forms white MgO.</li>
                    <li><strong>Ca + Water:</strong> Effervescence, slight heat, forms cloudy Ca(OH)₂ solution.</li>
                    <li><strong>Ba + Water:</strong> Vigorous reaction, more heat, forms alkaline solution.</li>
                </ul>
            `,
            safetyNotes: `
                <h3 class="text-2xl font-semibold mt-6 mb-2 text-emerald-300">Safety Notes for both Groups</h3>
                <ul>
                    <li>Store under oil to prevent reaction with air/moisture</li>
                    <li>Wear goggles, lab coat, gloves</li>
                    <li>Use small pieces for reactions</li>
                    <li>Never touch with bare hands</li>
                    <li>Rb, Cs, Ba are too reactive for most school demonstrations</li>
                </ul>
            `
        };
        const preQuizQuestions = [
            {
                type: 'multiple-choice',
                question: "Which Group 1 metal floats on water?",
                options: ["Lithium", "Sodium", "Potassium", "Cesium"],
                answer: "Lithium"
            },
            {
                type: 'multiple-choice',
                question: "Which metal reacts most vigorously with water?",
                options: ["Sodium", "Potassium", "Lithium", "Magnesium"],
                answer: "Potassium"
            },
            {
                type: 'drag-and-drop',
                question: "Match the metal to the gas released when reacting with water:",
                items: ["Li", "Na", "K", "Ca", "Mg"],
                answer: ["Li → H₂", "Na → H₂", "K → H₂", "Ca → H₂", "Mg → H₂"]
            },
            {
                type: 'multiple-choice',
                question: "Which Group 2 metal reacts very slowly with cold water but faster with steam?",
                options: ["Calcium", "Magnesium", "Barium", "Strontium"],
                answer: "Magnesium"
            },
            {
                type: 'click-to-select',
                question: "Which oxide is formed when potassium reacts with oxygen?",
                options: ["KO", "K₂O", "K₂O₂", "KO₂"],
                answer: "KO₂"
            },
            {
                type: 'multiple-choice',
                question: "Which hydroxide is most soluble in water?",
                options: ["Mg(OH)₂", "Ca(OH)₂", "Ba(OH)₂", "Be(OH)₂"],
                answer: "Ba(OH)₂"
            },
            {
                type: 'drag-and-drop',
                question: "Arrange these metals from least reactive to most reactive with water:",
                items: ["Li", "Na", "K", "Ca"],
                answer: ["Li", "Ca", "Na", "K"]
            }
        ];
        
        const postQuizQuestions = [
            {
                type: 'multiple-choice',
                question: "Which statement correctly describes the outer electron configuration?",
                options: ["A. Group 1 → ns², Group 2 → ns¹", "B. Group 1 → ns¹, Group 2 → ns²", "C. Both → ns¹", "D. Both → ns²"],
                answer: "B. Group 1 → ns¹, Group 2 → ns²"
            },
            {
                type: 'fill-in-the-blank',
                question: "Complete the equation for calcium reacting with water:",
                textBefore: "Equation: ",
                equation: "Ca + 2H₂O → ",
                blanks: [
                    { name: 'product', answer: 'Ca(OH)₂' },
                    { name: 'gas', answer: 'H₂' }
                ]
            },
            {
                type: 'drag-and-drop',
                question: "Place the metals in order of increasing reactivity:",
                items: ["Lithium (Li)", "Sodium (Na)", "Potassium (K)", "Cesium (Cs)"],
                answer: ["Lithium (Li)", "Sodium (Na)", "Potassium (K)", "Cesium (Cs)"]
            },
            {
                type: 'mcq-flame-colours',
                question: "Match the correct flame colour to each:",
                subQuestions: [
                    { label: "Lithium", options: ["Crimson red", "Lilac", "Brick red", "Apple green"], answer: "Crimson red" },
                    { label: "Potassium", options: ["Crimson red", "Lilac", "Brick red", "Apple green"], answer: "Lilac" },
                    { label: "Calcium", options: ["Crimson red", "Lilac", "Brick red", "Apple green"], answer: "Brick red" },
                    { label: "Barium", options: ["Crimson red", "Lilac", "Brick red", "Apple green"], answer: "Apple green" },
                ]
            },
            {
                type: 'short-answer',
                question: "What is the charge on the ion formed by:",
                subQuestions: [
                    { label: "Magnesium", answer: "+2" },
                    { label: "Sodium", answer: "+1" },
                ]
            },
            {
                type: 'true-or-false',
                question: "Group 1 density increases steadily with atomic number.",
                answer: "False",
                explanation: "(Irregular trend)"
            },
            {
                type: 'true-or-false',
                question: "Group 2 hydroxides become more soluble down the group.",
                answer: "True"
            },
            {
                type: 'multiple-choice',
                question: "Why is potassium stored under oil?",
                options: ["A. To reduce melting point", "B. To prevent contact with oxygen and moisture in air", "C. To make it more reactive", "D. To slow tarnishing only"],
                answer: "B. To prevent contact with oxygen and moisture in air"
            },
            {
                type: 'equation-balancing',
                question: "Balance the equation for the decomposition of magnesium carbonate:",
                equation: "MgCO₃ → MgO + CO₂",
                blanks: [
                    { name: 'MgCO₃', answer: '1' },
                    { name: 'MgO', answer: '1' },
                    { name: 'CO₂', answer: '1' }
                ]
            },
            {
                type: 'match-the-pair',
                question: "Match the observation to the metal:",
                items: [
                    { observation: "Fizzes gently, moves slowly", metal: "Lithium" },
                    { observation: "Lilac flame during reaction", metal: "Potassium" },
                    { observation: "Brick red flame, steady bubbling", metal: "Calcium" }
                ],
                matches: {
                    "Fizzes gently, moves slowly": "Lithium",
                    "Lilac flame during reaction": "Potassium",
                    "Brick red flame, steady bubbling": "Calcium"
                }
            },
            {
                type: 'extended-response',
                question: "Explain two differences in chemical reactivity between Group 1 and Group 2 metals, relating your answer to their electronic structures.",
                answer: "Group 1 metals have one outer electron, Group 2 have two; Group 1 metals lose their outer electron more easily, so they are more reactive; Group 2 metals form hydroxides that are less soluble than those of Group 1."
            }
        ];
        // UI References
        const ui = {
            mainContent: document.getElementById('main-content'),
            hubGrid: document.getElementById('hub-grid'),
            learnPanel: document.getElementById('learn-panel'),
            group1Tab: document.getElementById('group-1-tab'),
            group2Tab: document.getElementById('group-2-tab'),
            group1ContentDiv: document.getElementById('group-1-content'),
            group2ContentDiv: document.getElementById('group-2-content'),
            safetyNotesDiv: document.getElementById('safety-notes-content'),
            prequizPanel: document.getElementById('prequiz-panel'),
            prequizContentDiv: document.getElementById('prequiz-content'),
            factsContent: document.getElementById('facts-content'),
            group1ElementsContainer: document.querySelector('#group-i-elements div'),
            group2ElementsContainer: document.querySelector('#group-ii-elements div'),
            messageBox: document.getElementById('message-box'),
            messageText: document.getElementById('message-text'),
            closeMessageBtn: document.getElementById('close-message-btn'),
            prequizSubmitBtn: document.getElementById('prequiz-submit-btn'),
            prequizResultsDiv: document.getElementById('prequiz-results'),
            postquizPanel: document.getElementById('postquiz-panel'),
            postquizContentDiv: document.getElementById('postquiz-content'),
            postquizSubmitBtn: document.getElementById('postquiz-submit-btn'),
            postquizResultsDiv: document.getElementById('postquiz-results')
        };
        
        // --- Utility functions ---
        
        async function typeHtmlWithKeywords(element, htmlString, delay = 5) {
            if (typingAnimationRunning) {
                clearTimeout(animationTimeout);
            }
            element.innerHTML = "";
            typingAnimationRunning = true;
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            const paragraphs = doc.body.children;
            const animateParagraph = (pIndex) => {
                if (pIndex >= paragraphs.length) {
                    typingAnimationRunning = false;
                    return;
                }
                const currentParagraph = paragraphs[pIndex];
                const parts = [];
                currentParagraph.childNodes.forEach(node => {
                    if (node.nodeType === Node.TEXT_NODE) {
                        parts.push({ type: 'text', content: node.textContent });
                    } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'SPAN') {
                        parts.push({ type: 'html', content: node.outerHTML });
                    } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'B') {
                        parts.push({ type: 'html', content: node.outerHTML });
                    } else if (node.nodeType === Node.ELEMENT_NODE && (node.tagName === 'SUP' || node.tagName === 'SUB')) {
                         parts.push({ type: 'html', content: node.outerHTML });
                    } else if (node.nodeType === Node.ELEMENT_NODE) {
                        parts.push({ type: 'html', content: node.outerHTML });
                    }
                });
                let partIndex = 0;
                let charIndex = 0;
                
                const type = () => {
                    if (partIndex >= parts.length) {
                        element.innerHTML += '<br>';
                        animateParagraph(pIndex + 1);
                        return;
                    }
                    
                    const currentPart = parts[partIndex];
                    if (currentPart.type === 'html') {
                        element.innerHTML += currentPart.content;
                        partIndex++;
                        charIndex = 0;
                    } else { // type: 'text'
                        if (charIndex < currentPart.content.length) {
                            element.innerHTML += currentPart.content.charAt(charIndex);
                            charIndex++;
                        } else {
                            partIndex++;
                            charIndex = 0;
                        }
                    }
                    animationTimeout = setTimeout(type, delay);
                };
                type();
            };
            
            animateParagraph(0);
        }
        
        function showMessage(message) {
            ui.messageText.textContent = message;
            ui.messageBox.classList.remove('hidden');
        }
        function hideMessage() {
            ui.messageBox.classList.add('hidden');
        }
        
        function adjustFontSizeToFit(container, minSize = 8) {
            let fontSize = 16;
            // Reset font size before adjustment
            container.style.fontSize = ''; 
            
            while (container.scrollHeight > container.clientHeight && fontSize > minSize) {
                fontSize--;
                container.style.fontSize = `${fontSize}px`;
            }
        }
        // --- 2D Atom Viewer (Canvas) ---
        let canvas, ctx;
        let animationFrameId;
        let atom = null;
        let currentElement = null;
        let scale = 1;
        let translateX = 0;
        let translateY = 0;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        function init2DViewer() {
            canvas = document.getElementById('atom-canvas');
            ctx = canvas.getContext('2d');
            
            const resizeCanvas = () => {
                const parent = canvas.parentElement;
                const size = Math.min(parent.clientWidth, parent.clientHeight);
                if (size > 0) { // Only resize if parent is visible
                    canvas.width = size;
                    canvas.height = size;
                    
                    if (currentElement) {
                        updateAtomViewer(currentElement);
                    } else {
                         drawDefaultMessage();
                    }
                }
            };
            window.addEventListener('resize', resizeCanvas);
            // Add mouse events for pan and zoom
            canvas.addEventListener('wheel', handleWheel);
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('mouseleave', handleMouseUp);
        }
        function handleWheel(e) {
            e.preventDefault();
            const zoomSpeed = 0.1;
            const mouseX = e.clientX - canvas.getBoundingClientRect().left;
            const mouseY = e.clientY - canvas.getBoundingClientRect().top;
            
            const oldScale = scale;
            const newScale = e.deltaY < 0 ? oldScale * (1 + zoomSpeed) : oldScale / (1 + zoomSpeed);
            
            scale = Math.max(0.5, Math.min(newScale, 3)); 
            translateX = mouseX - (mouseX - translateX) * (scale / oldScale);
            translateY = mouseY - (mouseY - translateY) * (scale / oldScale);
        }
        function handleMouseDown(e) {
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
        }
        function handleMouseMove(e) {
            if (!isDragging) return;
            const deltaX = e.clientX - lastMouseX;
            const deltaY = e.clientY - lastMouseY;
            translateX += deltaX;
            translateY += deltaY;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
        }
        function handleMouseUp() {
            isDragging = false;
        }
        function animate() {
            if (atom) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                atom.electronOrbits.forEach(orbit => {
                    orbit.angle += orbit.speed;
                });
                drawAtom(currentElement, atom);
            }
            animationFrameId = requestAnimationFrame(animate);
        }
        
        function drawDefaultMessage() {
            if (!ctx || !canvas) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.fillStyle = '#e2e8f0';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = '24px "Inter", sans-serif';
            ctx.fillText("Select an element to view its atom", canvas.width / 2, canvas.height / 2);
            ctx.restore();
            // Stop any previous animation
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        }
        function drawAtom(element, atomData) {
            if (!ctx || !element || !atomData) return;
            ctx.save();
            ctx.translate(canvas.width / 2 + translateX, canvas.height / 2 + translateY);
            ctx.scale(scale, scale);
            ctx.beginPath();
            ctx.arc(0, 0, 30, 0, Math.PI * 2);
            ctx.fillStyle = '#ef4444';
            ctx.shadowColor = '#ef4444';
            ctx.shadowBlur = 10;
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.fillStyle = '#ffffff';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = 'bold 18px "Inter", sans-serif';
            ctx.fillText(element.symbol, 0, -10);
            ctx.font = '12px "Inter", sans-serif';
            ctx.fillText(element.atomicNumber, 0, 10);
            atomData.electronOrbits.forEach(orbit => {
                ctx.beginPath();
                ctx.arc(0, 0, orbit.radius, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(204, 204, 204, 0.2)';
                ctx.lineWidth = 2;
                ctx.stroke();
                orbit.electrons.forEach((electron, index) => {
                    const electronX = 0 + orbit.radius * Math.cos(orbit.angle + (index * ((Math.PI * 2) / orbit.electrons.length)));
                    const electronY = 0 + orbit.radius * Math.sin(orbit.angle + (index * ((Math.PI * 2) / orbit.electrons.length)));
                    ctx.beginPath();
                    ctx.arc(electronX, electronY, 8, 0, Math.PI * 2);
                    ctx.fillStyle = electron.isValence ? '#fcd34d' : '#4ade80';
                    ctx.shadowColor = electron.isValence ? '#fcd34d' : '#4ade80';
                    ctx.shadowBlur = 8;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                });
            });
            ctx.restore();
        }
        
        function updateAtomViewer(element) {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            currentElement = element;
            const { electrons: numElectrons, group } = element;
            
            const numValenceElectrons = (group === 'I' || group === 'i') ? 1 : 2;
            const numInnerElectrons = numElectrons - numValenceElectrons;
            const shellCapacities = [2, 8, 18, 32, 18, 8, 2];
            let remainingInnerElectrons = numInnerElectrons;
            let currentRadius = 50;
            const orbits = [];
            for (let i = 0; i < shellCapacities.length && remainingInnerElectrons > 0; i++) {
                const electronsInShell = Math.min(shellCapacities[i], remainingInnerElectrons);
                
                const electronArray = [];
                for (let j = 0; j < electronsInShell; j++) {
                    electronArray.push({ isValence: false });
                }
                
                orbits.push({
                    radius: currentRadius,
                    electrons: electronArray,
                    angle: Math.random() * Math.PI * 2,
                    speed: 0.01 / (i + 1)
                });
                remainingInnerElectrons -= electronsInShell;
                currentRadius += 40;
            }
            const valenceElectronArray = [];
            for (let j = 0; j < numValenceElectrons; j++) {
                valenceElectronArray.push({ isValence: true });
            }
            orbits.push({
                radius: currentRadius,
                electrons: valenceElectronArray,
                angle: Math.random() * Math.PI * 2,
                speed: 0.01 / (orbits.length + 1)
            });
            
            atom = {
                electronOrbits: orbits
            };
            
            const largestRadius = orbits.length > 0 ? orbits[orbits.length - 1].radius : 0;
            const atomDiameter = (largestRadius + 8) * 2;
            const padding = 100;
            
            // Re-calculate canvas dimensions and scale just before drawing
            const parent = canvas.parentElement;
            const size = Math.min(parent.clientWidth, parent.clientHeight);
            canvas.width = size;
            canvas.height = size;
            
            const minDimension = Math.min(canvas.width, canvas.height);
            if (atomDiameter > 0) {
                scale = minDimension / (atomDiameter + padding);
            } else {
                scale = 1;
            }
            translateX = 0;
            translateY = 0;
            
            animate();
        }
        
        // --- End 2D Atom Viewer ---
        // --- UI & Event Handlers ---
        // Function to update the facts panel with colored text
        function updateFactsPanel(elementName) {
            const element = elementsData[elementName];
            if (!element) return;
        
            ui.factsContent.innerHTML = "";
            ui.factsContent.style.fontSize = ''; // Reset font size
            
            const facts = [
                `<p class="text-base mb-2"><span class="text-purple-300 font-bold">Atomic Number:</span> ${element.atomicNumber}</p>`,
                `<p class="text-base mb-2"><span class="text-purple-300 font-bold">Protons:</span> ${element.protons}</p>`,
                `<p class="text-base mb-2"><span class="text-purple-300 font-bold">Neutrons:</span> ${element.neutrons}</p>`,
                `<p class="text-base mb-2"><span class="text-purple-300 font-bold">Electrons:</span> ${element.electrons}</p>`,
                `<p class="text-base mb-2"><span class="text-purple-300 font-bold">Electron Configuration:</span> ${element.electronConfiguration}</p>`,
                `<p class="text-base mb-2"><span class="text-purple-300 font-bold">Symbol:</span> ${element.symbol} - ${elementName}</p>`,
                `<p class="text-base mb-2"><span class="text-purple-300 font-bold">Melting Point:</span> ${element.meltingPoint}</p>`,
                `<p class="text-base mb-2"><span class="text-purple-300 font-bold">Boiling Point:</span> ${element.boilingPoint}</p>`,
                `<p class="text-base mb-2"><span class="text-purple-300 font-bold">Ionization Energy:</span> ${element.ionizationEnergy}</p>`,
                `<p class="text-base mb-2"><span class="text-purple-300 font-bold">Electronegativity:</span> ${element.electronegativity}</p>`,
                `<p class="text-base mb-2"><span class="text-purple-300 font-bold">Fun Fact:</span> ${element.funFact}</p>`
            ];
            
            const factsHTML = facts.join('');
            typeHtmlWithKeywords(ui.factsContent, factsHTML, 20); // Call the new typing function
            adjustFontSizeToFit(ui.factsContent);
        }
        function showLearnSection(group) {
            // Deactivate all tabs and content panels first
            ui.group1Tab.classList.remove('active');
            ui.group1Tab.setAttribute('aria-selected', 'false');
            ui.group1ContentDiv.classList.add('hidden');
            ui.group2Tab.classList.remove('active');
            ui.group2Tab.setAttribute('aria-selected', 'false');
            ui.group2ContentDiv.classList.add('hidden');
            // Activate the selected tab and content panel
            if (group === 'group1') {
                ui.group1Tab.classList.add('active');
                ui.group1Tab.setAttribute('aria-selected', 'true');
                ui.group1ContentDiv.classList.remove('hidden');
                ui.group1ContentDiv.innerHTML = learnContent.group1;
                ui.safetyNotesDiv.innerHTML = learnContent.safetyNotes;
            } else if (group === 'group2') {
                ui.group2Tab.classList.add('active');
                ui.group2Tab.setAttribute('aria-selected', 'true');
                ui.group2ContentDiv.classList.remove('hidden');
                ui.group2ContentDiv.innerHTML = learnContent.group2;
                ui.safetyNotesDiv.innerHTML = learnContent.safetyNotes;
            }
        }
        function openLearnPanel() {
            ui.hubGrid.classList.add('hidden');
            ui.prequizPanel.classList.add('hidden');
            ui.postquizPanel.classList.add('hidden');
            ui.learnPanel.classList.remove('hidden');
            // Default to showing Group 1 when the panel opens
            showLearnSection('group1');
        }
        
        function openPrequizPanel() {
            ui.hubGrid.classList.add('hidden');
            ui.learnPanel.classList.add('hidden');
            ui.postquizPanel.classList.add('hidden');
            ui.prequizPanel.classList.remove('hidden');
            generateQuizUI(preQuizQuestions, ui.prequizContentDiv);
        }
        function openPostquizPanel() {
            const preQuizCompleted = localStorage.getItem(`${appId}-preQuizCompleted`);
            if (!preQuizCompleted) {
                showMessage("You must complete the pre-quiz before attempting the post-quiz.");
                return;
            }
            ui.hubGrid.classList.add('hidden');
            ui.learnPanel.classList.add('hidden');
            ui.prequizPanel.classList.add('hidden');
            ui.postquizPanel.classList.remove('hidden');
            generatePostQuizUI();
        }
        
        function openHubPanel() {
            ui.prequizPanel.classList.add('hidden');
            ui.learnPanel.classList.add('hidden');
            ui.postquizPanel.classList.add('hidden');
            ui.hubGrid.classList.remove('hidden');
            
            // Force the canvas to resize now that its parent is visible
            const parent = canvas.parentElement;
            const size = Math.min(parent.clientWidth, parent.clientHeight);
            canvas.width = size;
            canvas.height = size;
            
            if (currentElement) {
                updateAtomViewer(currentElement);
            } else {
                drawDefaultMessage();
            }
        }
        function generateQuizUI(questions, container) {
            container.innerHTML = '';
            
            let quizHTML = '';
            questions.forEach((q, index) => {
                quizHTML += `<div class="bg-zinc-800 p-6 rounded-lg mb-6 appear-anim" style="animation-delay: ${index * 0.1}s;">`;
                quizHTML += `<p class="text-lg font-semibold mb-3">${index + 1}. ${q.question}</p>`;
                
                if (q.type === 'multiple-choice') {
                    quizHTML += `<div class="flex flex-col space-y-2">`;
                    q.options.forEach(option => {
                        quizHTML += `
                            <button class="quiz-option p-3 rounded-md bg-zinc-700 text-left border-2 border-zinc-700 hover:border-purple-500" data-question-index="${index}" data-answer="${option}">
                                ${option}
                            </button>
                        `;
                    });
                    quizHTML += `</div>`;
                } else if (q.type === 'click-to-select') {
                    quizHTML += `<div class="flex flex-wrap gap-2">`;
                    q.options.forEach(option => {
                        quizHTML += `
                            <button class="quiz-option px-3 py-2 rounded-md bg-zinc-700 border-2 border-zinc-700 hover:border-purple-500" data-question-index="${index}" data-answer="${option}">
                                ${option}
                            </button>
                        `;
                    });
                    quizHTML += `</div>`;
                } else if (q.type === 'drag-and-drop') {
                    const shuffledItems = [...q.items].sort(() => Math.random() - 0.5);
                    quizHTML += `
                        <div class="flex flex-col space-y-4">
                            <div id="drag-items-container-${index}" class="flex flex-row flex-wrap justify-center gap-4 p-4 bg-zinc-700 rounded-lg dropzone-container" data-type="source">
                                ${shuffledItems.map((item) => `
                                    <div class="draggable-item p-3 rounded-md bg-zinc-600 text-center border-2 border-zinc-700" draggable="true" data-value="${item}">
                                        ${item}
                                    </div>
                                `).join('')}
                            </div>
                            <div id="drag-container-${index}" class="flex flex-wrap justify-center gap-1">
                                ${Array(q.answer.length).fill(0).map((_, i) => `
                                    <div class="flex items-center">
                                        <div class="dropzone dropzone-container" data-type="target" data-index="${i}" style="min-width: 80px; padding: 4px;">Drop Here</div>
                                        ${i < q.answer.length - 1 ? '<span class="text-2xl text-zinc-500 mx-1">→</span>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                quizHTML += `</div>`;
            });
            
            container.innerHTML = quizHTML;
            
            // --- Event Listeners for Quiz UI ---
            container.querySelectorAll('.quiz-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const index = e.target.dataset.questionIndex;
                    container.querySelectorAll(`.quiz-option[data-question-index='${index}']`).forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                });
            });
            
            container.querySelectorAll('.draggable-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    const data = {
                        value: e.target.dataset.value,
                        originType: e.target.parentElement.dataset.type,
                        originId: e.target.parentElement.id
                    };
                    e.dataTransfer.setData('text/plain', JSON.stringify(data));
                    e.target.classList.add('dragging');
                });
                item.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                });
            });
            
            container.querySelectorAll('.dropzone-container').forEach(dropzone => {
                dropzone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropzone.classList.add('drag-over');
                });
                dropzone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('drag-over');
                });
                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('drag-over');
                    
                    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                    const draggedElement = container.querySelector(`.draggable-item[data-value="${data.value}"]`);
                    
                    // If dropping on source container
                    if (dropzone.dataset.type === 'source') {
                        // Only move if not already in source
                        if (data.originType !== 'source') {
                            dropzone.appendChild(draggedElement);
                        }
                    } 
                    // If dropping on target dropzone
                    else {
                        // Check if dropzone already has an item
                        const existingItem = dropzone.querySelector('.draggable-item');
                        
                        if (existingItem) {
                            // If dragged from source container
                            if (data.originType === 'source') {
                                // Move existing item back to source
                                const sourceContainer = document.getElementById(data.originId);
                                sourceContainer.appendChild(existingItem);
                                // Move dragged element to current dropzone
                                dropzone.appendChild(draggedElement);
                            } 
                            // If dragged from another dropzone
                            else {
                                // Swap items
                                const originDropzone = document.getElementById(data.originId);
                                originDropzone.appendChild(existingItem);
                                dropzone.appendChild(draggedElement);
                            }
                        } else {
                            // Dropzone is empty, just append
                            dropzone.appendChild(draggedElement);
                        }
                        
                        // Clear "Drop Here" text if it exists
                        if (dropzone.textContent.trim() === 'Drop Here') {
                            dropzone.textContent = '';
                        }
                    }
                });
            });
        }
        
        function checkAnswers(questions, container, resultsDiv) {
            let score = 0;
            let totalScore = 0;
            
            questions.forEach((q, index) => {
                const questionDiv = container.querySelector(`.bg-zinc-800.mb-6:nth-of-type(${index + 1})`);
                let isCorrect = false;
                
                if (q.type === 'multiple-choice' || q.type === 'click-to-select') {
                    const selectedOption = questionDiv.querySelector('.quiz-option.selected');
                    if (selectedOption && selectedOption.dataset.answer === q.answer) {
                        isCorrect = true;
                    }
                    
                    const allOptions = questionDiv.querySelectorAll('.quiz-option');
                    allOptions.forEach(option => {
                        option.disabled = true;
                        if (option.dataset.answer === q.answer) {
                            option.classList.add('correct');
                        } else if (option.classList.contains('selected')) {
                            option.classList.add('incorrect');
                        }
                    });
                } else if (q.type === 'drag-and-drop') {
                    const orderedItems = [...questionDiv.querySelectorAll('.dropzone[data-type="target"]')].map(zone => {
                        const item = zone.querySelector('.draggable-item');
                        return item ? item.dataset.value : null;
                    });
                    
                    if (orderedItems.every(item => item !== null) && JSON.stringify(orderedItems) === JSON.stringify(q.answer)) {
                        isCorrect = true;
                    }
                    
                    const dropzones = questionDiv.querySelectorAll('.dropzone[data-type="target"]');
                    dropzones.forEach((zone, itemIndex) => {
                        const item = zone.querySelector('.draggable-item');
                        if (item) {
                            if (item.dataset.value === q.answer[itemIndex]) {
                                item.classList.add('bg-green-700', 'border-green-500');
                            } else {
                                item.classList.add('bg-red-700', 'border-red-500');
                            }
                            item.draggable = false;
                            item.style.cursor = 'default';
                        }
                        zone.style.borderColor = 'transparent';
                        zone.style.cursor = 'default';
                    });
                    
                    const dragItemsContainer = questionDiv.querySelector('[id^="drag-items-container-"]');
                    if (dragItemsContainer) {
                         [...dragItemsContainer.children].forEach(item => {
                            if (item.classList.contains('draggable-item')) {
                                item.draggable = false;
                                item.style.cursor = 'default';
                            }
                        });
                    }
                    
                    if (!isCorrect) {
                        const correctOrderDiv = document.createElement('p');
                        correctOrderDiv.className = "mt-2 text-sm text-green-300";
                        correctOrderDiv.textContent = `Correct Order: ${q.answer.join(' → ')}`;
                        questionDiv.appendChild(correctOrderDiv);
                    }
                }
                
                if (isCorrect) {
                    score++;
                }
                totalScore++;
            });
            
            resultsDiv.textContent = `You scored ${score} out of ${totalScore}!`;
            resultsDiv.classList.add('text-yellow-300');
            
            localStorage.setItem(`${appId}-preQuizCompleted`, 'true');
            
            setTimeout(() => {
                openHubPanel();
            }, 3000);
        }
        // Post-Quiz specific functions
        function generatePostQuizUI() {
            ui.postquizContentDiv.innerHTML = '';
            ui.postquizResultsDiv.innerHTML = '';
            let quizHTML = '';
            postQuizQuestions.forEach((q, index) => {
                quizHTML += `<div class="bg-zinc-800 p-6 rounded-lg mb-6 appear-anim" style="animation-delay: ${index * 0.1}s;">`;
                quizHTML += `<p class="text-lg font-semibold mb-3">${index + 1}. ${q.question}</p>`;
                if (q.type === 'multiple-choice') {
                    quizHTML += `<div class="flex flex-col space-y-2">`;
                    q.options.forEach(option => {
                        quizHTML += `
                            <button class="quiz-option p-3 rounded-md bg-zinc-700 border-2 border-zinc-700 hover:border-rose-500" data-question-index="${index}" data-answer="${option}">
                                ${option}
                            </button>
                        `;
                    });
                    quizHTML += `</div>`;
                } else if (q.type === 'mcq-flame-colours') {
                    q.subQuestions.forEach(sq => {
                        quizHTML += `
                            <p class="mt-4">${sq.label} &ndash; </p>
                            <div class="flex flex-wrap gap-2 mb-2">
                                ${sq.options.map(option => `
                                    <button class="quiz-option px-3 py-1 rounded-md bg-zinc-700 border-2 border-zinc-700 hover:border-rose-500" data-question-index="${index}" data-sub-label="${sq.label}" data-answer="${option}">
                                        ${option}
                                    </button>
                                `).join('')}
                            </div>
                        `;
                    });
                } else if (q.type === 'fill-in-the-blank') {
                    quizHTML += `
                        <div class="flex items-center space-x-2">
                            <span>Ca + 2H₂O → </span>
                            <input type="text" id="blank-product-${index}" class="fill-in-blank-input" placeholder="...">
                            <span> + </span>
                            <input type="text" id="blank-gas-${index}" class="fill-in-blank-input" placeholder="...">
                        </div>
                    `;
                } else if (q.type === 'drag-and-drop') {
                    const shuffledItems = [...q.items].sort(() => Math.random() - 0.5);
                    quizHTML += `
                        <div class="flex flex-col space-y-4">
                            <div id="drag-items-container-post-${index}" class="flex flex-row flex-wrap justify-center gap-4 p-4 bg-zinc-700 rounded-lg dropzone-container" data-type="source">
                                ${shuffledItems.map((item) => `
                                    <div class="draggable-item p-3 rounded-md bg-zinc-600 text-center border-2 border-zinc-700" draggable="true" data-value="${item}">
                                        ${item}
                                    </div>
                                `).join('')}
                            </div>
                            <div class="flex flex-row space-x-2 items-center justify-center">
                                <span class="text-sm text-zinc-400">Least Reactive</span>
                                <span class="text-4xl text-zinc-500">→</span>
                                <span class="text-sm text-zinc-400">Most Reactive</span>
                            </div>
                            <div id="drag-container-post-${index}" class="flex flex-row space-x-2 justify-center">
                                <div class="dropzone dropzone-container" data-type="target" data-index="0">Drop Here</div>
                                <span class="text-4xl text-zinc-500 mx-2">→</span>
                                <div class="dropzone dropzone-container" data-type="target" data-index="1">Drop Here</div>
                                <span class="text-4xl text-zinc-500 mx-2">→</span>
                                <div class="dropzone dropzone-container" data-type="target" data-index="2">Drop Here</div>
                                <span class="text-4xl text-zinc-500 mx-2">→</span>
                                <div class="dropzone dropzone-container" data-type="target" data-index="3">Drop Here</div>
                            </div>
                        </div>
                    `;
                } else if (q.type === 'short-answer') {
                    q.subQuestions.forEach(sq => {
                        quizHTML += `
                            <div class="flex items-center space-x-2 mt-4">
                                <span>${sq.label} → </span>
                                <input type="text" id="short-answer-${sq.label.toLowerCase()}-${index}" class="fill-in-blank-input" placeholder="...">
                            </div>
                        `;
                    });
                } else if (q.type === 'true-or-false') {
                    quizHTML += `<div class="flex space-x-4 mt-2">
                        <button class="quiz-option p-3 rounded-md bg-zinc-700 border-2 border-zinc-700 hover:border-rose-500" data-question-index="${index}" data-answer="True">True</button>
                        <button class="quiz-option p-3 rounded-md bg-zinc-700 border-2 border-zinc-700 hover:border-rose-500" data-question-index="${index}" data-answer="False">False</button>
                    </div>`;
                } else if (q.type === 'equation-balancing') {
                    quizHTML += `
                        <div class="flex items-center space-x-2 mt-4">
                            <input type="text" id="coeff-1-${index}" class="fill-in-blank-input" placeholder="1">
                            <span>MgCO₃ → </span>
                            <input type="text" id="coeff-2-${index}" class="fill-in-blank-input" placeholder="1">
                            <span>MgO + </span>
                            <input type="text" id="coeff-3-${index}" class="fill-in-blank-input" placeholder="1">
                            <span>CO₂</span>
                        </div>
                    `;
                } else if (q.type === 'match-the-pair') {
                    const shuffledObservations = [...q.items.map(i => i.observation)].sort(() => Math.random() - 0.5);
                    quizHTML += `
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div class="flex flex-col">
                                <h4 class="font-bold text-rose-300">Observations</h4>
                                <div id="match-items-container-${index}" class="mt-2 space-y-2">
                                    ${shuffledObservations.map(obs => `
                                        <div class="match-item" draggable="true" data-value="${obs}">
                                            ${obs}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <h4 class="font-bold text-rose-300">Metals</h4>
                                <div id="match-dropzones-${index}" class="mt-2 space-y-2">
                                    ${q.items.map(item => `
                                        <div class="p-2 border-2 border-dashed border-gray-600 rounded-md bg-zinc-700 dropzone-match" data-value="${item.metal}">
                                            ${item.metal}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else if (q.type === 'extended-response') {
                    quizHTML += `
                        <textarea id="extended-response-${index}" class="w-full h-32 p-3 mt-2 rounded-md bg-zinc-700 border-2 border-zinc-600 text-white focus:outline-none focus:border-rose-500"></textarea>
                    `;
                }
                quizHTML += `</div>`;
            });
            ui.postquizContentDiv.innerHTML = quizHTML;
            
            // Re-apply event listeners for the dynamic content
            ui.postquizContentDiv.querySelectorAll('.quiz-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const questionIndex = e.target.dataset.questionIndex;
                    const subLabel = e.target.dataset.subLabel;
                    
                    if (subLabel) {
                        ui.postquizContentDiv.querySelectorAll(`.quiz-option[data-question-index="${questionIndex}"][data-sub-label="${subLabel}"]`).forEach(btn => btn.classList.remove('selected'));
                    } else {
                        ui.postquizContentDiv.querySelectorAll(`.quiz-option[data-question-index="${questionIndex}"]`).forEach(btn => btn.classList.remove('selected'));
                    }
                    e.target.classList.add('selected');
                });
            });
            
            // Add drag-and-drop event listeners for post-quiz
            ui.postquizContentDiv.querySelectorAll('.draggable-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    const data = {
                        value: e.target.dataset.value,
                        originType: e.target.parentElement.dataset.type,
                        originId: e.target.parentElement.id
                    };
                    e.dataTransfer.setData('text/plain', JSON.stringify(data));
                    e.target.classList.add('dragging');
                });
                item.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                });
            });
            
            ui.postquizContentDiv.querySelectorAll('.dropzone-container').forEach(dropzone => {
                dropzone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropzone.classList.add('drag-over');
                });
                dropzone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('drag-over');
                });
                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('drag-over');
                    
                    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                    const draggedElement = ui.postquizContentDiv.querySelector(`.draggable-item[data-value="${data.value}"]`);
                    
                    // If dropping on source container
                    if (dropzone.dataset.type === 'source') {
                        // Only move if not already in source
                        if (data.originType !== 'source') {
                            dropzone.appendChild(draggedElement);
                        }
                    } 
                    // If dropping on target dropzone
                    else {
                        // Check if dropzone already has an item
                        const existingItem = dropzone.querySelector('.draggable-item');
                        
                        if (existingItem) {
                            // If dragged from source container
                            if (data.originType === 'source') {
                                // Move existing item back to source
                                const sourceContainer = document.getElementById(data.originId);
                                sourceContainer.appendChild(existingItem);
                                // Move dragged element to current dropzone
                                dropzone.appendChild(draggedElement);
                            } 
                            // If dragged from another dropzone
                            else {
                                // Swap items
                                const originDropzone = document.getElementById(data.originId);
                                originDropzone.appendChild(existingItem);
                                dropzone.appendChild(draggedElement);
                            }
                        } else {
                            // Dropzone is empty, just append
                            dropzone.appendChild(draggedElement);
                        }
                        
                        // Clear "Drop Here" text if it exists
                        if (dropzone.textContent.trim() === 'Drop Here') {
                            dropzone.textContent = '';
                        }
                    }
                });
            });
            
            ui.postquizContentDiv.querySelectorAll('.dropzone-match').forEach(dropzone => {
                dropzone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropzone.classList.add('drag-over');
                });
                dropzone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('drag-over');
                });
                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('drag-over');
                    const data = e.dataTransfer.getData('text/plain');
                    const draggedElement = ui.postquizContentDiv.querySelector(`.match-item[data-value="${data}"]`);
                    if (dropzone.children.length === 0) {
                        dropzone.appendChild(draggedElement);
                    }
                });
            });
        }
        function checkPostQuizAnswers() {
            let score = 0;
            const totalQuestions = postQuizQuestions.length;
            postQuizQuestions.forEach((q, index) => {
                const questionDiv = ui.postquizContentDiv.querySelector(`.bg-zinc-800.mb-6:nth-of-type(${index + 1})`);
                let isCorrect = false;
                switch (q.type) {
                    case 'multiple-choice':
                    case 'true-or-false':
                        const selectedOption = questionDiv.querySelector('.quiz-option.selected');
                        if (selectedOption && selectedOption.dataset.answer === q.answer) {
                            isCorrect = true;
                        }
                        const allOptions = questionDiv.querySelectorAll('.quiz-option');
                        allOptions.forEach(option => {
                            option.disabled = true;
                            if (option.dataset.answer === q.answer) {
                                option.classList.add('correct');
                            } else if (option.classList.contains('selected')) {
                                option.classList.add('incorrect');
                            }
                        });
                        break;
                    case 'fill-in-the-blank':
                        const productInput = questionDiv.querySelector(`#blank-product-${index}`);
                        const gasInput = questionDiv.querySelector(`#blank-gas-${index}`);
                        if (productInput.value.trim() === q.blanks[0].answer && gasInput.value.trim() === q.blanks[1].answer) {
                            isCorrect = true;
                        }
                        productInput.disabled = true;
                        gasInput.disabled = true;
                        const resultP = document.createElement('p');
                        resultP.className = "mt-2 text-sm";
                        if (isCorrect) {
                            resultP.textContent = `Correct!`;
                            resultP.classList.add('text-green-400');
                        } else {
                            resultP.textContent = `Incorrect. Correct answer: Ca + 2H₂O → Ca(OH)₂ + H₂`;
                            resultP.classList.add('text-red-400');
                        }
                        questionDiv.appendChild(resultP);
                        break;
                    case 'drag-and-drop':
                        const orderedItems = [...questionDiv.querySelectorAll('.dropzone[data-type="target"]')].map(zone => {
                            const item = zone.querySelector('.draggable-item');
                            return item ? item.dataset.value : null;
                        });
                        if (orderedItems.every(item => item !== null) && JSON.stringify(orderedItems) === JSON.stringify(q.answer)) {
                            isCorrect = true;
                        }
                        break;
                    case 'mcq-flame-colours':
                        const subQuestions = q.subQuestions;
                        let allCorrect = true;
                        subQuestions.forEach(sq => {
                            const selectedOption = questionDiv.querySelector(`.quiz-option.selected[data-sub-label="${sq.label}"]`);
                            if (!selectedOption || selectedOption.dataset.answer !== sq.answer) {
                                allCorrect = false;
                            }
                            questionDiv.querySelectorAll(`.quiz-option[data-sub-label="${sq.label}"]`).forEach(btn => {
                                btn.disabled = true;
                                if (btn.dataset.answer === sq.answer) {
                                    btn.classList.add('correct');
                                } else if (btn.classList.contains('selected')) {
                                    btn.classList.add('incorrect');
                                }
                            });
                        });
                        isCorrect = allCorrect;
                        break;
                    case 'short-answer':
                        const saInputs = questionDiv.querySelectorAll('input[type="text"]');
                        let saCorrect = true;
                        saInputs.forEach((input, saIndex) => {
                            const label = q.subQuestions[saIndex].label.toLowerCase();
                            const answer = q.subQuestions[saIndex].answer;
                            if (input.value.trim() !== answer) {
                                saCorrect = false;
                            }
                            input.disabled = true;
                            const resultSpan = document.createElement('span');
                            resultSpan.className = "ml-2 text-sm";
                            if (input.value.trim() === answer) {
                                resultSpan.textContent = `✅`;
                                resultSpan.classList.add('text-green-400');
                            } else {
                                resultSpan.textContent = `❌ (Correct: ${answer})`;
                                resultSpan.classList.add('text-red-400');
                            }
                            input.parentElement.appendChild(resultSpan);
                        });
                        isCorrect = saCorrect;
                        break;
                    case 'equation-balancing':
                        const coeffInputs = questionDiv.querySelectorAll('input[type="text"]');
                        let eqCorrect = true;
                        coeffInputs.forEach((input, eqIndex) => {
                            if (input.value.trim() !== q.blanks[eqIndex].answer) {
                                eqCorrect = false;
                            }
                            input.disabled = true;
                            if (input.value.trim() === q.blanks[eqIndex].answer) {
                                input.classList.add('bg-green-700', 'border-green-500');
                            } else {
                                input.classList.add('bg-red-700', 'border-red-500');
                            }
                        });
                        isCorrect = eqCorrect;
                        break;
                    case 'match-the-pair':
                        let mpCorrect = true;
                        const dropzones = questionDiv.querySelectorAll('.dropzone-match');
                        dropzones.forEach(zone => {
                            const metal = zone.dataset.value;
                            const observationElement = zone.querySelector('.match-item');
                            if (!observationElement || q.matches[observationElement.dataset.value] !== metal) {
                                mpCorrect = false;
                                if (observationElement) {
                                    observationElement.classList.add('bg-red-700', 'border-red-500');
                                }
                            } else {
                                observationElement.classList.add('bg-green-700', 'border-green-500');
                            }
                        });
                        isCorrect = mpCorrect;
                        const unmatchedItems = questionDiv.querySelectorAll('.match-item:not(.bg-green-700)');
                        unmatchedItems.forEach(item => {
                            item.draggable = false;
                            item.classList.add('bg-red-700', 'border-red-500');
                        });
                        break;
                    case 'extended-response':
                        const responseArea = questionDiv.querySelector('textarea');
                        responseArea.disabled = true;
                        const correctResponse = document.createElement('div');
                        correctResponse.className = "mt-4 p-3 rounded-md bg-zinc-700 text-sm text-green-300";
                        correctResponse.innerHTML = `<b>Model Answer:</b> ${q.answer}`;
                        questionDiv.appendChild(correctResponse);
                        isCorrect = true; // Don't penalize score for this.
                        break;
                }
                if (isCorrect) {
                    score++;
                }
            });
            ui.postquizSubmitBtn.disabled = true;
            ui.postquizResultsDiv.textContent = `You scored ${score} out of ${postQuizQuestions.length} on the graded questions!`;
            ui.postquizResultsDiv.classList.add('text-yellow-300');
            
            setTimeout(() => {
                openHubPanel();
            }, 5000);
        }
        // --- Main App Initialization ---
        async function firebaseInit() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        isAuthReady = true;
                        console.log("Firebase initialized and user authenticated:", userId);
                    } else {
                        console.log("Firebase initialized, no user authenticated.");
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        };
        document.addEventListener('DOMContentLoaded', async () => {
            await firebaseInit();
            init2DViewer();
            
            Object.entries(elementsData).forEach(([name, data]) => {
                const button = document.createElement('button');
                const hoverColor = data.group === 'I' ? 'hover:bg-sky-700' : 'hover:bg-emerald-700';
                const borderColor = data.group === 'I' ? 'border-sky-700' : 'border-emerald-700';
                button.className = `element-card p-4 rounded-lg bg-zinc-800 ${hoverColor} transition-all duration-300 shadow-md text-left border ${borderColor}`;
                button.dataset.element = name;
                button.innerHTML = `<h4 class="font-bold text-lg text-white">${data.symbol}</h4><p class="text-sm">${name}</p>`;
                if (data.group === 'I') {
                    ui.group1ElementsContainer.appendChild(button);
                } else {
                    ui.group2ElementsContainer.appendChild(button);
                }
            });
            document.getElementById('nav-hub-btn').addEventListener('click', openHubPanel);
            document.getElementById('nav-learn-btn').addEventListener('click', openLearnPanel);
            document.getElementById('nav-prequiz-btn').addEventListener('click', () => {
                ui.prequizResultsDiv.textContent = '';
                ui.prequizSubmitBtn.disabled = false;
                openPrequizPanel();
            });
            document.getElementById('nav-postquiz-btn').addEventListener('click', () => {
                ui.postquizResultsDiv.textContent = '';
                ui.postquizSubmitBtn.disabled = false;
                openPostquizPanel();
            });
            
            document.getElementById('back-to-hub-btn').addEventListener('click', openHubPanel);
            document.getElementById('back-to-hub-btn-quiz').addEventListener('click', openHubPanel);
            document.getElementById('back-to-hub-btn-postquiz').addEventListener('click', openHubPanel);
            ui.prequizSubmitBtn.addEventListener('click', () => checkAnswers(preQuizQuestions, ui.prequizContentDiv, ui.prequizResultsDiv));
            ui.postquizSubmitBtn.addEventListener('click', checkPostQuizAnswers);
            document.querySelectorAll('#nav-leaderboard-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    showMessage("This feature is still under construction. Please check back later!");
                });
            });
            ui.closeMessageBtn.addEventListener('click', hideMessage);
            // Add event listeners for the new tab buttons
            ui.group1Tab.addEventListener('click', () => showLearnSection('group1'));
            ui.group2Tab.addEventListener('click', () => showLearnSection('group2'));
            document.querySelectorAll('.element-card').forEach(button => {
                button.addEventListener('click', () => {
                    openHubPanel(); // Ensure the hub panel is visible
                    const elementName = button.getAttribute('data-element');
                    const element = elementsData[elementName];
                    if (element) {
                        updateFactsPanel(elementName);
                        updateAtomViewer(element);
                    }
                });
            });
            // Start with the hub panel visible by default
            openHubPanel();
        });
    </script>
</body>
</html>
